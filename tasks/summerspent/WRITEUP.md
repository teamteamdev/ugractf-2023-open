# Как я провелето: Write-up

Нехитрый интерфейс позволяет нам проводить поиск по некоторому массиву текстовых файлов. Интерфейс не даёт ввести номера меньше 500. Перебираем их, пользуясь предоставляемой функцией поиска в соседних файлах и задавая запросы вроде буквы «а», понимаем, что есть документы с номерами до 999, и также есть неизвестное количество документов с номерами меньше 500 — в них-то наверняка самое интересное.

Дан [исходный код](app/searcher.py) поискового движка, что позволяет разобраться с тем, как он устроен. На фоне весьма обычной логики выделяется формирование команд, осуществляющих поиск: формируется строка, которая потом подаётся на выполнение в bash.

Выясняем, что для поиска используется grep, то есть по поисковому запросу `.` мы будем видеть файлы целиком.

Сам запрос перед вызовом прогоняется через функцию `shlex.quote` — это преобразует его в единый токен и не оставляет никаких шансов вставить в это место команды что-либо, кроме безопасной строчки. Кроме того, он идёт после опции `-e`, гарантирующей, что следующий аргумент будет воспринят именно как запрос, даже если будет, например, начинаться с `-`, как другие опции grep.

Ещё в запрос подставляется номер документа. Причём берётся `number_str` в том виде, в котором мы его ввели, а не `number`, прошедший валидацию. Впрочем, валидация довольно жёсткая: преобразование из строки в `int` не пропускает лишних символов — кроме разве что пробелов (которые на команду никак не влияют) и нулей в начале.

При этом арифметика в bash воспринимает числа с нулём в начале как восьмеричные: например, запись `0500` означает восьмеричное «500», то есть 5×8² = 320. Такой номер документа проходит проверки и позволяет с помощью поиска по соседям достать документы с наименьшими номерами, то есть начиная с 318. Правда, при таком поиске сам документ 320 не отображается (номер текущего документа, в отличие от номеров соседей, не интерпретируется как число и остаётся как есть, а документа `0500.txt` не существует). Чтобы посмотреть его, откроем соседние документы вокруг `0501` (321). Там, в конце душераздирающей истории, и будет флаг.

```
Введите команду. > search
Введите поисковый запрос. > ugra_
Введите порядковый номер документа. > 0501
Введите 1, если требуется поиск по соседним документам, иначе 0. > 1
320.txt-крик слышится мне чаще других, и он кричит что-то очень
320.txt:неразборчивое, вроде такого: ugra_respect_the_sorrow_of_the_sufferers_fq7y5ibkhmwirml1
```

Флаг: **ugra_respect_the_sorrow_of_the_sufferers_fq7y5ibkhmwirml1**

## Альтернативный вариант

Различия в арифметике не заканчиваются на восьмеричной записи. bash-арифметика подвержена переполнению при работе с большими числами, в то время как тип int может хранить неограниченно большие числа. Так, мы можем взять большое положительное число, которое из-за переполнения будет обрезано до маленького.

```bash
$ echo $(( 18446744073709551934 ))
318
```

```
Введите команду. > search
Введите поисковый запрос. > ugra_
Введите порядковый номер документа. > 18446744073709551934
Введите 1, если требуется поиск по соседним документам, иначе 0. > 1
320.txt-крик слышится мне чаще других, и он кричит что-то очень
320.txt:неразборчивое, вроде такого: ugra_respect_the_sorrow_of_the_sufferers_fq7y5ibkhmwirml1
```

Флаг: **ugra_respect_the_sorrow_of_the_sufferers_fq7y5ibkhmwirml1**

## Ещё вариант

Ещё одна особенность синтаксиса арифметики bash — в числах воспринимаются только последние 64 символа, а всё, что левее, игнорируется. Это легко позволяет задать любой нужный номер.

```bash
$ echo $(( 9000000000000000000000000000000000000000000000000000000000000000318 ))
318
```

```
Введите команду. > search
Введите поисковый запрос. > ugra_
Введите порядковый номер документа. > 9000000000000000000000000000000000000000000000000000000000000000318
Введите 1, если требуется поиск по соседним документам, иначе 0. > 1
320.txt-крик слышится мне чаще других, и он кричит что-то очень
320.txt:неразборчивое, вроде такого: ugra_respect_the_sorrow_of_the_sufferers_fq7y5ibkhmwirml1
```

Флаг: **ugra_respect_the_sorrow_of_the_sufferers_fq7y5ibkhmwirml1**
