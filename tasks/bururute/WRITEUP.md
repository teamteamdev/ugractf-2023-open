# Войти и не пострадать: Write-up

Дана система, которая требует для входа в систему неизвестный одноразовый код из 5 символов. Название задания и происходящее в целом намекает, что потребуется перебор. Однако после 25 попыток (из требуемых в худшем случае 100 тысяч) нас банят по айпи:

![IP-адрес заблокирован](writeup/blocked.png)

Можно заметить, что наш IP-адрес (вернее, то, что сервер считает нашим IP-адресом) указан в комментарии внизу страницы (в том числе и до блокировки) — это позволит нам отладить механизмы обхода.

А механизмов может быть много.

* **IPv6**. Сервис доступен по IPv6, при этом под блокировку подпадают единичные адреса. Адресация в IPv6 устроена так, что на всех устройствах остаются огромные пространства адресов, в пределах которых можно назначать самому себе адреса как вздумается. Некоторые провайдеры предоставляют IPv6-доступ, также можно пользоваться [туннелями](https://tunnelbroker.net/) или серверами с IPv6-подключением.
* **TOR**. При обращении к сайту через TOR в качестве IP-адреса выступает адрес выходного узла. Сменить выходной узел, а значит, и IP-адрес, можно командой TOR-клиента.
* **Прокси**. Разновидность предыдущего метода: существуют списки открытых прокси-серверов, специально или случайно позволяющие пропускать через себя трафик всем желающим; сайты в таком случае видят IP-адрес прокси-сервера. Остаётся только найти достаточно таких прокси-серверов.
* **Краткосрочная аренда серверов**. У крупных облачных хостинг-провайдеров можно арендовать сервера с полноценными внешними IP-адресами; впрочем, это требует потратить деньги, хоть и очень небольшие (перебрать 25 кодов и прекратить пользование сервером можно очень быстро).
* **Переподключение к провайдеру**. Некоторые провайдеры меняют IP-адрес при каждом переподключении к ним — и таких смен теоретически могло бы хватить на весь перебор. Правда, подобное поведение провайдеров встречается всё реже.
* **Инъекция в заголовок**. Зачастую — и в данном случае это тоже было так — веб-приложения подключаются к сети не напрямую, а через промежуточный веб-сервер (например, nginx) или даже цепочку таких серверов. В таком случае процесс веб-приложения не имеет доступа к информации о сетевом подключении к клиенту, и информация об IP-адресе, если она нужна приложению, должна быть передана ему как-то ещё. Существует несколько распространённых способов, один из них (в настоящее время уже не рекомендуемый к использованию, но всё ещё широко поддерживаемый) — указание IP-адреса в HTTP-заголовке _X-Forwarded-For_. Проблема этого подхода в том, что HTTP-заголовки может отправлять и сам клиент, и должна быть настроена правильная фильтрация, чтобы недостоверные данные не воспринимались приложением. В данном случае можно было отправить заголовок X-Forwarded-For с любым значением, даже не обязательно соответствующим формату IP-адреса — и приложение принимало это значение за новый незаблокированный адрес.

## Собственно перебор

Например, для подхода с X-Forwarded-For можно перебрать одноразовые коды вот таким скриптом:

```bash
for otp in {00000..99999}; do
    echo $i
    curl -i https://bururute.o.2023.ugractf.ru/mtn19urjxpa3kmn8/ --data-raw "otp=$otp" -H "X-Forwarded-For: $otp" > $otp.html
done
```

Потом среди файлов достаточно найти один с отличающимся размером — флаг будет прямо там.

Флаг: **ugra_[keep_calm_we_will_sit_down_together](https://www.youtube.com/watch?v=9VO7z6qpjVE)_8wzpuqx582fzz5w8**
